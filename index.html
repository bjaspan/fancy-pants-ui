<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gate Judging App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for a native-app feel */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            -webkit-tap-highlight-color: transparent; /* Disable tap highlight */
        }
        /* Style for the radio button labels */
        .radio-label {
            transition: all 0.1s ease-in-out;
            padding: 0.75rem 0.5rem; /* 12px 8px */
            font-size: 0.875rem; /* 14px */
            line-height: 1.25rem; /* 20px */
            border-radius: 0.5rem; /* 8px */
            text-align: center;
            cursor: pointer;
            display: block;
            width: 100%;
        }
        /* Prevent selection of text on tap */
        .radio-label, .btn {
            -webkit-user-select: none; /* Safari */
            -ms-user-select: none; /* IE 10+ */
            user-select: none; /* Standard */
        }

        /* Compact Gate Row Layout */
        .gate-row-grid {
            display: grid;
            grid-template-columns: auto 1fr 1fr 1fr; /* Label, Clean, Touch, Fifty */
            gap: 0.5rem; /* 8px */
            align-items: center;
        }
        .gate-label {
            font-size: 1.125rem; /* 18px */
            font-weight: 600;
            text-align: left;
            padding-left: 0.25rem; /* 4px */
        }

    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen p-4" ontouchstart="">

    <!-- Main Content Container -->
    <div class="max-w-lg mx-auto bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">

        <!-- Loading State -->
        <div id="loading-state" class="text-center p-8">
            <h1 class="text-2xl font-bold mb-4">Loading Race Data...</h1>
            <p id="loading-error" class="text-red-500"></p>
        </div>

        <!-- Form Content (Hidden by default) -->
        <div id="form-content" class="hidden">
            <h1 id="race-title" class="text-3xl font-bold text-center mb-6">Gate Judging</h1>

            <form id="gate-form" novalidate>
                <!-- Station Selector -->
                <div id="station-section" class="mb-5">
                    <!-- Label removed as requested -->
                    <select id="station-selector" name="station" required class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-lg bg-white dark:bg-gray-700 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="" disabled selected>Select a station</option>
                        <!-- Options will be dynamically populated -->
                    </select>
                </div>

                <!-- Bib Number (Hidden by default) -->
                <div id="bib-section" class="mb-5 hidden">
                    <label for="bib-number" class="block text-lg font-medium text-gray-700 dark:text-gray-300 mb-2">Bib Number</label>
                    <input type="text" id="bib-number" name="entry.1708578938" required
                           inputmode="numeric"
                           class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-lg bg-white dark:bg-gray-700 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="Enter bib number">
                </div>

                <!-- Gates Container (Hidden by default) -->
                <div id="gates-container" class="space-y-3 hidden"> <!-- Reduced space-y -->
                    <!-- Gates 1-25 will be dynamically populated or hardcoded here -->

                    <!-- Gate 1 -->
                    <div id="gate-1" class="gate-row hidden p-2 bg-gray-50 dark:bg-gray-700 rounded-lg shadow-sm">
                        <div class="gate-row-grid">
                            <h3 class="gate-label">Gate 1</h3>
                            <div class="relative">
                                <input type="radio" id="gate-1-clean" name="entry.55002585" value="Clean" class="sr-only peer" checked>
                                <label for="gate-1-clean" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-blue-600 peer-checked:text-white dark:peer-checked:bg-blue-500 hover:bg-gray-300 dark:hover:bg-gray-500">Clean</label>
                            </div>
                            <div class="relative">
                                <input type="radio" id="gate-1-touch" name="entry.55002585" value="Touch" class="sr-only peer">
                                <label for="gate-1-touch" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-yellow-500 peer-checked:text-black dark:peer-checked:bg-yellow-400 hover:bg-gray-300 dark:hover:bg-gray-500">Touch</label>
                            </div>
                            <div class="relative">
                                <input type="radio" id="gate-1-fifty" name="entry.55002585" value="Fifty" class="sr-only peer">
                                <label for="gate-1-fifty" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-red-600 peer-checked:text-white dark:peer-checked:bg-red-500 hover:bg-gray-300 dark:hover:bg-gray-500">Fifty</label>
                            </div>
                        </div>
                    </div>

                    <!-- Gate 2 -->
                    <div id="gate-2" class="gate-row hidden p-2 bg-gray-50 dark:bg-gray-700 rounded-lg shadow-sm">
                        <div class="gate-row-grid">
                            <h3 class="gate-label">Gate 2</h3>
                            <div class="relative">
                                <input type="radio" id="gate-2-clean" name="entry.1855197499" value="Clean" class="sr-only peer" checked>
                                <label for="gate-2-clean" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-blue-600 peer-checked:text-white dark:peer-checked:bg-blue-500 hover:bg-gray-300 dark:hover:bg-gray-500">Clean</label>
                            </div>
                            <div class="relative">
                                <input type="radio" id="gate-2-touch" name="entry.1855197499" value="Touch" class="sr-only peer">
                                <label for="gate-2-touch" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-yellow-500 peer-checked:text-black dark:peer-checked:bg-yellow-400 hover:bg-gray-300 dark:hover:bg-gray-500">Touch</label>
                            </div>
                            <div class="relative">
                                <input type="radio" id="gate-2-fifty" name="entry.1855197499" value="Fifty" class="sr-only peer">
                                <label for="gate-2-fifty" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-red-600 peer-checked:text-white dark:peer-checked:bg-red-500 hover:bg-gray-300 dark:hover:bg-gray-500">Fifty</label>
                            </div>
                        </div>
                    </div>

                    <!-- Gate 3 -->
                    <div id="gate-3" class="gate-row hidden p-2 bg-gray-50 dark:bg-gray-700 rounded-lg shadow-sm">
                        <div class="gate-row-grid">
                            <h3 class="gate-label">Gate 3</h3>
                            <div class="relative">
                                <input type="radio" id="gate-3-clean" name="entry.838150175" value="Clean" class="sr-only peer" checked>
                                <label for="gate-3-clean" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-blue-600 peer-checked:text-white dark:peer-checked:bg-blue-500 hover:bg-gray-300 dark:hover:bg-gray-500">Clean</label>
                            </div>
                            <div class="relative">
                                <input type="radio" id="gate-3-touch" name="entry.838150175" value="Touch" class="sr-only peer">
                                <label for="gate-3-touch" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-yellow-500 peer-checked:text-black dark:peer-checked:bg-yellow-400 hover:bg-gray-300 dark:hover:bg-gray-500">Touch</label>
                            </div>
                            <div class="relative">
                                <input type="radio" id="gate-3-fifty" name="entry.838150175" value="Fifty" class="sr-only peer">
                                <label for="gate-3-fifty" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-red-600 peer-checked:text-white dark:peer-checked:bg-red-500 hover:bg-gray-300 dark:hover:bg-gray-500">Fifty</label>
                            </div>
                        </div>
                    </div>

                    <!-- Gate 4 -->
                    <div id="gate-4" class="gate-row hidden p-2 bg-gray-50 dark:bg-gray-700 rounded-lg shadow-sm">
                        <div class="gate-row-grid">
                            <h3 class="gate-label">Gate 4</h3>
                            <div class="relative">
                                <input type="radio" id="gate-4-clean" name="entry.2134907932" value="Clean" class="sr-only peer" checked>
                                <label for="gate-4-clean" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-blue-600 peer-checked:text-white dark:peer-checked:bg-blue-500 hover:bg-gray-300 dark:hover:bg-gray-500">Clean</label>
                            </div>
                            <div class="relative">
                                <input type="radio" id="gate-4-touch" name="entry.2134907932" value="Touch" class="sr-only peer">
                                <label for="gate-4-touch" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-yellow-500 peer-checked:text-black dark:peer-checked:bg-yellow-400 hover:bg-gray-300 dark:hover:bg-gray-500">Touch</label>
                            </div>
                            <div class="relative">
                                <input type="radio" id="gate-4-fifty" name="entry.2134907932" value="Fifty" class="sr-only peer">
                                <label for="gate-4-fifty" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-red-600 peer-checked:text-white dark:peer-checked:bg-red-500 hover:bg-gray-300 dark:hover:bg-gray-500">Fifty</label>
                            </div>
                        </div>
                    </div>

                    <!-- Gate 5 -->
                    <div id="gate-5" class="gate-row hidden p-2 bg-gray-50 dark:bg-gray-700 rounded-lg shadow-sm">
                        <div class="gate-row-grid">
                            <h3 class="gate-label">Gate 5</h3>
                            <div class="relative">
                                <input type="radio" id="gate-5-clean" name="entry.76231793" value="Clean" class="sr-only peer" checked>
                                <label for="gate-5-clean" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-blue-600 peer-checked:text-white dark:peer-checked:bg-blue-500 hover:bg-gray-300 dark:hover:bg-gray-500">Clean</label>
                            </div>
                            <div class="relative">
                                <input type="radio" id="gate-5-touch" name="entry.76231793" value="Touch" class="sr-only peer">
                                <label for="gate-5-touch" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-yellow-500 peer-checked:text-black dark:peer-checked:bg-yellow-400 hover:bg-gray-300 dark:hover:bg-gray-500">Touch</label>
                            </div>
                            <div class="relative">
                                <input type="radio" id="gate-5-fifty" name="entry.76231793" value="Fifty" class="sr-only peer">
                                <label for="gate-5-fifty" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-red-600 peer-checked:text-white dark:peer-checked:bg-red-500 hover:bg-gray-300 dark:hover:bg-gray-500">Fifty</label>
                            </div>
                        </div>
                    </div>

                    <!-- Gate 6 -->
                    <div id="gate-6" class="gate-row hidden p-2 bg-gray-50 dark:bg-gray-700 rounded-lg shadow-sm">
                        <div class="gate-row-grid">
                            <h3 class="gate-label">Gate 6</h3>
                            <div class="relative">
                                <input type="radio" id="gate-6-clean" name="entry.2014836299" value="Clean" class="sr-only peer" checked>
                                <label for="gate-6-clean" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-blue-600 peer-checked:text-white dark:peer-checked:bg-blue-500 hover:bg-gray-300 dark:hover:bg-gray-500">Clean</label>
                            </div>
                            <div class="relative">
                                <input type="radio" id="gate-6-touch" name="entry.2014836299" value="Touch" class="sr-only peer">
                                <label for="gate-6-touch" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-yellow-500 peer-checked:text-black dark:peer-checked:bg-yellow-400 hover:bg-gray-300 dark:hover:bg-gray-500">Touch</label>
                            </div>
                            <div class="relative">
                                <input type="radio" id="gate-6-fifty" name="entry.2014836299" value="Fifty" class="sr-only peer">
                                <label for="gate-6-fifty" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-red-600 peer-checked:text-white dark:peer-checked:bg-red-500 hover:bg-gray-300 dark:hover:bg-gray-500">Fifty</label>
                            </div>
                        </div>
                    </div>

                    <!-- Gate 7 -->
                    <div id="gate-7" class="gate-row hidden p-2 bg-gray-50 dark:bg-gray-700 rounded-lg shadow-sm">
                        <div class="gate-row-grid">
                            <h3 class="gate-label">Gate 7</h3>
                            <div class="relative">
                                <input type="radio" id="gate-7-clean" name="entry.1263576022" value="Clean" class="sr-only peer" checked>
                                <label for="gate-7-clean" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-blue-600 peer-checked:text-white dark:peer-checked:bg-blue-500 hover:bg-gray-300 dark:hover:bg-gray-500">Clean</label>
                            </div>
                            <div class="relative">
                                <input type="radio" id="gate-7-touch" name="entry.1263576022" value="Touch" class="sr-only peer">
                                <label for="gate-7-touch" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-yellow-500 peer-checked:text-black dark:peer-checked:bg-yellow-400 hover:bg-gray-300 dark:hover:bg-gray-500">Touch</label>
                            </div>
                            <div class="relative">
                                <input type="radio" id="gate-7-fifty" name="entry.1263576022" value="Fifty" class="sr-only peer">
                                <label for="gate-7-fifty" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-red-600 peer-checked:text-white dark:peer-checked:bg-red-500 hover:bg-gray-300 dark:hover:bg-gray-500">Fifty</label>
                            </div>
                        </div>
                    </div>

                    <!-- Gate 8 -->
                    <div id="gate-8" class="gate-row hidden p-2 bg-gray-50 dark:bg-gray-700 rounded-lg shadow-sm">
                        <div class="gate-row-grid">
                            <h3 class="gate-label">Gate 8</h3>
                            <div class="relative">
                                <input type="radio" id="gate-8-clean" name="entry.714148965" value="Clean" class="sr-only peer" checked>
                                <label for="gate-8-clean" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-blue-600 peer-checked:text-white dark:peer-checked:bg-blue-500 hover:bg-gray-300 dark:hover:bg-gray-500">Clean</label>
                            </div>
                            <div class="relative">
                                <input type="radio" id="gate-8-touch" name="entry.714148965" value="Touch" class="sr-only peer">
                                <label for="gate-8-touch" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-yellow-500 peer-checked:text-black dark:peer-checked:bg-yellow-400 hover:bg-gray-300 dark:hover:bg-gray-500">Touch</label>
                            </div>
                            <div class="relative">
                                <input type="radio" id="gate-8-fifty" name="entry.714148965" value="Fifty" class="sr-only peer">
                                <label for="gate-8-fifty" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-red-600 peer-checked:text-white dark:peer-checked:bg-red-500 hover:bg-gray-300 dark:hover:bg-gray-500">Fifty</label>
                            </div>
                        </div>
                    </div>

                    <!-- Gate 9 -->
                    <div id="gate-9" class="gate-row hidden p-2 bg-gray-50 dark:bg-gray-700 rounded-lg shadow-sm">
                        <div class="gate-row-grid">
                            <h3 class="gate-label">Gate 9</h3>
                            <div class="relative">
                                <input type="radio" id="gate-9-clean" name="entry.2091158156" value="Clean" class="sr-only peer" checked>
                                <label for="gate-9-clean" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-blue-600 peer-checked:text-white dark:peer-checked:bg-blue-500 hover:bg-gray-300 dark:hover:bg-gray-500">Clean</label>
                            </div>
                            <div class="relative">
                                <input type="radio" id="gate-9-touch" name="entry.2091158156" value="Touch" class="sr-only peer">
                                <label for="gate-9-touch" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-yellow-500 peer-checked:text-black dark:peer-checked:bg-yellow-400 hover:bg-gray-300 dark:hover:bg-gray-500">Touch</label>
                            </div>
                            <div class="relative">
                                <input type="radio" id="gate-9-fifty" name="entry.2091158156" value="Fifty" class="sr-only peer">
                                <label for="gate-9-fifty" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-red-600 peer-checked:text-white dark:peer-checked:bg-red-500 hover:bg-gray-300 dark:hover:bg-gray-500">Fifty</label>
                            </div>
                        </div>
                    </div>

                    <!-- Gate 10 -->
                    <div id="gate-10" class="gate-row hidden p-2 bg-gray-50 dark:bg-gray-700 rounded-lg shadow-sm">
                        <div class="gate-row-grid">
                            <h3 class="gate-label">Gate 10</h3>
                            <div class="relative">
                                <input type="radio" id="gate-10-clean" name="entry.954036935" value="Clean" class="sr-only peer" checked>
                                <label for="gate-10-clean" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-blue-600 peer-checked:text-white dark:peer-checked:bg-blue-500 hover:bg-gray-300 dark:hover:bg-gray-500">Clean</label>
                            </div>
                            <div class="relative">
                                <input type="radio" id="gate-10-touch" name="entry.954036935" value="Touch" class="sr-only peer">
                                <label for="gate-10-touch" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-yellow-500 peer-checked:text-black dark:peer-checked:bg-yellow-400 hover:bg-gray-300 dark:hover:bg-gray-500">Touch</label>
                            </div>
                            <div class="relative">
                                <input type="radio" id="gate-10-fifty" name="entry.954036935" value="Fifty" class="sr-only peer">
                                <label for="gate-10-fifty" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-red-600 peer-checked:text-white dark:peer-checked:bg-red-500 hover:bg-gray-300 dark:hover:bg-gray-500">Fifty</label>
                            </div>
                        </div>
                    </div>

                    <!-- Gate 11 -->
                    <div id="gate-11" class="gate-row hidden p-2 bg-gray-50 dark:bg-gray-700 rounded-lg shadow-sm">
                        <div class="gate-row-grid">
                            <h3 class="gate-label">Gate 11</h3>
                            <div class="relative">
                                <input type="radio" id="gate-11-clean" name="entry.1849885105" value="Clean" class="sr-only peer" checked>
                                <label for="gate-11-clean" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-blue-600 peer-checked:text-white dark:peer-checked:bg-blue-500 hover:bg-gray-300 dark:hover:bg-gray-500">Clean</label>
                            </div>
                            <div class="relative">
                                <input type="radio" id="gate-11-touch" name="entry.1849885105" value="Touch" class="sr-only peer">
                                <label for="gate-11-touch" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-yellow-500 peer-checked:text-black dark:peer-checked:bg-yellow-400 hover:bg-gray-300 dark:hover:bg-gray-500">Touch</label>
                            </div>
                            <div class="relative">
                                <input type="radio" id="gate-11-fifty" name="entry.1849885105" value="Fifty" class="sr-only peer">
                                <label for="gate-11-fifty" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-red-600 peer-checked:text-white dark:peer-checked:bg-red-500 hover:bg-gray-300 dark:hover:bg-gray-500">Fifty</label>
                            </div>
                        </div>
                    </div>

                    <!-- Gate 12 -->
                    <div id="gate-12" class="gate-row hidden p-2 bg-gray-50 dark:bg-gray-700 rounded-lg shadow-sm">
                        <div class="gate-row-grid">
                            <h3 class="gate-label">Gate 12</h3>
                            <div class="relative">
                                <input type="radio" id="gate-12-clean" name="entry.1598024978" value="Clean" class="sr-only peer" checked>
                                <label for="gate-12-clean" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-blue-600 peer-checked:text-white dark:peer-checked:bg-blue-500 hover:bg-gray-300 dark:hover:bg-gray-500">Clean</label>
                            </div>
                            <div class="relative">
                                <input type="radio" id="gate-12-touch" name="entry.1598024978" value="Touch" class="sr-only peer">
                                <label for="gate-12-touch" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-yellow-500 peer-checked:text-black dark:peer-checked:bg-yellow-400 hover:bg-gray-300 dark:hover:bg-gray-500">Touch</label>
                            </div>
                            <div class="relative">
                                <input type="radio" id="gate-12-fifty" name="entry.1598024978" value="Fifty" class="sr-only peer">
                                <label for="gate-12-fifty" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-red-600 peer-checked:text-white dark:peer-checked:bg-red-500 hover:bg-gray-300 dark:hover:bg-gray-500">Fifty</label>
                            </div>
                        </div>
                    </div>

                    <!-- Gate 13 -->
                    <div id="gate-13" class="gate-row hidden p-2 bg-gray-50 dark:bg-gray-700 rounded-lg shadow-sm">
                        <div class="gate-row-grid">
                            <h3 class="gate-label">Gate 13</h3>
                            <div class="relative">
                                <input type="radio" id="gate-13-clean" name="entry.1849166482" value="Clean" class="sr-only peer" checked>
                                <label for="gate-13-clean" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-blue-600 peer-checked:text-white dark:peer-checked:bg-blue-500 hover:bg-gray-300 dark:hover:bg-gray-500">Clean</label>
                            </div>
                            <div class="relative">
                                <input type="radio" id="gate-13-touch" name="entry.1849166482" value="Touch" class="sr-only peer">
                                <label for="gate-13-touch" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-yellow-500 peer-checked:text-black dark:peer-checked:bg-yellow-400 hover:bg-gray-300 dark:hover:bg-gray-500">Touch</label>
                            </div>
                            <div class="relative">
                                <input type="radio" id="gate-13-fifty" name="entry.1849166482" value="Fifty" class="sr-only peer">
                                <label for="gate-13-fifty" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-red-600 peer-checked:text-white dark:peer-checked:bg-red-500 hover:bg-gray-300 dark:hover:bg-gray-500">Fifty</label>
                            </div>
                        </div>
                    </div>

                    <!-- Gate 14 -->
                    <div id="gate-14" class="gate-row hidden p-2 bg-gray-50 dark:bg-gray-700 rounded-lg shadow-sm">
                        <div class="gate-row-grid">
                            <h3 class="gate-label">Gate 14</h3>
                            <div class="relative">
                                <input type="radio" id="gate-14-clean" name="entry.1790035018" value="Clean" class="sr-only peer" checked>
                                <label for="gate-14-clean" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-blue-600 peer-checked:text-white dark:peer-checked:bg-blue-500 hover:bg-gray-300 dark:hover:bg-gray-500">Clean</label>
                            </div>
                            <div class="relative">
                                <input type="radio" id="gate-14-touch" name="entry.1790035018" value="Touch" class="sr-only peer">
                                <label for="gate-14-touch" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-yellow-500 peer-checked:text-black dark:peer-checked:bg-yellow-400 hover:bg-gray-300 dark:hover:bg-gray-500">Touch</label>
                            </div>
                            <div class="relative">
                                <input type="radio" id="gate-14-fifty" name="entry.1790035018" value="Fifty" class="sr-only peer">
                                <label for="gate-14-fifty" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-red-600 peer-checked:text-white dark:peer-checked:bg-red-500 hover:bg-gray-300 dark:hover:bg-gray-500">Fifty</label>
                            </div>
                        </div>
                    </div>

                    <!-- Gate 15 -->
                    <div id="gate-15" class="gate-row hidden p-2 bg-gray-50 dark:bg-gray-700 rounded-lg shadow-sm">
                        <div class="gate-row-grid">
                            <h3 class="gate-label">Gate 15</h3>
                            <div class="relative">
                                <input type="radio" id="gate-15-clean" name="entry.51888731" value="Clean" class="sr-only peer" checked>
                                <label for="gate-15-clean" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-blue-600 peer-checked:text-white dark:peer-checked:bg-blue-500 hover:bg-gray-300 dark:hover:bg-gray-500">Clean</label>
                            </div>
                            <div class="relative">
                                <input type="radio" id="gate-15-touch" name="entry.51888731" value="Touch" class="sr-only peer">
                                <label for="gate-15-touch" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-yellow-500 peer-checked:text-black dark:peer-checked:bg-yellow-400 hover:bg-gray-300 dark:hover:bg-gray-500">Touch</label>
                            </div>
                            <div class="relative">
                                <input type="radio" id="gate-15-fifty" name="entry.51888731" value="Fifty" class="sr-only peer">
                                <label for="gate-15-fifty" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-red-600 peer-checked:text-white dark:peer-checked:bg-red-500 hover:bg-gray-300 dark:hover:bg-gray-500">Fifty</label>
                            </div>
                        </div>
                    </div>

                    <!-- Gate 16 -->
                    <div id="gate-16" class="gate-row hidden p-2 bg-gray-50 dark:bg-gray-700 rounded-lg shadow-sm">
                        <div class="gate-row-grid">
                            <h3 class="gate-label">Gate 16</h3>
                            <div class="relative">
                                <input type="radio" id="gate-16-clean" name="entry.1479632689" value="Clean" class="sr-only peer" checked>
                                <label for="gate-16-clean" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-blue-600 peer-checked:text-white dark:peer-checked:bg-blue-500 hover:bg-gray-300 dark:hover:bg-gray-500">Clean</label>
                            </div>
                            <div class="relative">
                                <input type="radio" id="gate-16-touch" name="entry.1479632689" value="Touch" class="sr-only peer">
                                <label for="gate-16-touch" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-yellow-500 peer-checked:text-black dark:peer-checked:bg-yellow-400 hover:bg-gray-300 dark:hover:bg-gray-500">Touch</label>
                            </div>
                            <div class="relative">
                                <input type="radio" id="gate-16-fifty" name="entry.1479632689" value="Fifty" class="sr-only peer">
                                <label for="gate-16-fifty" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-red-600 peer-checked:text-white dark:peer-checked:bg-red-500 hover:bg-gray-300 dark:hover:bg-gray-500">Fifty</label>
                            </div>
                        </div>
                    </div>

                    <!-- Gate 17 -->
                    <div id="gate-17" class="gate-row hidden p-2 bg-gray-50 dark:bg-gray-700 rounded-lg shadow-sm">
                        <div class="gate-row-grid">
                            <h3 class="gate-label">Gate 17</h3>
                            <div class="relative">
                                <input type="radio" id="gate-17-clean" name="entry.331391847" value="Clean" class="sr-only peer" checked>
                                <label for="gate-17-clean" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-blue-600 peer-checked:text-white dark:peer-checked:bg-blue-500 hover:bg-gray-300 dark:hover:bg-gray-500">Clean</label>
                            </div>
                            <div class="relative">
                                <input type="radio" id="gate-17-touch" name="entry.331391847" value="Touch" class="sr-only peer">
                                <label for="gate-17-touch" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-yellow-500 peer-checked:text-black dark:peer-checked:bg-yellow-400 hover:bg-gray-300 dark:hover:bg-gray-500">Touch</label>
                            </div>
                            <div class="relative">
                                <input type="radio" id="gate-17-fifty" name="entry.331391847" value="Fifty" class="sr-only peer">
                                <label for="gate-17-fifty" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-red-600 peer-checked:text-white dark:peer-checked:bg-red-500 hover:bg-gray-300 dark:hover:bg-gray-500">Fifty</label>
                            </div>
                        </div>
                    </div>

                    <!-- Gate 18 -->
                    <div id="gate-18" class="gate-row hidden p-2 bg-gray-50 dark:bg-gray-700 rounded-lg shadow-sm">
                        <div class="gate-row-grid">
                            <h3 class="gate-label">Gate 18</h3>
                            <div class="relative">
                                <input type="radio" id="gate-18-clean" name="entry.1598320935" value="Clean" class="sr-only peer" checked>
                                <label for="gate-18-clean" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-blue-600 peer-checked:text-white dark:peer-checked:bg-blue-500 hover:bg-gray-300 dark:hover:bg-gray-500">Clean</label>
                            </div>
                            <div class="relative">
                                <input type="radio" id="gate-18-touch" name="entry.1598320935" value="Touch" class="sr-only peer">
                                <label for="gate-18-touch" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-yellow-500 peer-checked:text-black dark:peer-checked:bg-yellow-400 hover:bg-gray-300 dark:hover:bg-gray-500">Touch</label>
                            </div>
                            <div class="relative">
                                <input type="radio" id="gate-18-fifty" name="entry.1598320935" value="Fifty" class="sr-only peer">
                                <label for="gate-18-fifty" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-red-600 peer-checked:text-white dark:peer-checked:bg-red-500 hover:bg-gray-300 dark:hover:bg-gray-500">Fifty</label>
                            </div>
                        </div>
                    </div>

                    <!-- Gate 19 -->
                    <div id="gate-19" class="gate-row hidden p-2 bg-gray-50 dark:bg-gray-700 rounded-lg shadow-sm">
                        <div class="gate-row-grid">
                            <h3 class="gate-label">Gate 19</h3>
                            <div class="relative">
                                <input type="radio" id="gate-19-clean" name="entry.1176839769" value="Clean" class="sr-only peer" checked>
                                <label for="gate-19-clean" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-blue-600 peer-checked:text-white dark:peer-checked:bg-blue-500 hover:bg-gray-300 dark:hover:bg-gray-500">Clean</label>
                            </div>
                            <div class="relative">
                                <input type="radio" id="gate-19-touch" name="entry.1176839769" value="Touch" class="sr-only peer">
                                <label for="gate-19-touch" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-yellow-500 peer-checked:text-black dark:peer-checked:bg-yellow-400 hover:bg-gray-300 dark:hover:bg-gray-500">Touch</Labe>
                            </div>
                            <div class="relative">
                                <input type="radio" id="gate-19-fifty" name="entry.1176839769" value="Fifty" class="sr-only peer">
                                <label for="gate-19-fifty" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-red-600 peer-checked:text-white dark:peer-checked:bg-red-500 hover:bg-gray-300 dark:hover:bg-gray-500">Fifty</label>
                            </div>
                        </div>
                    </div>

                    <!-- Gate 20 -->
                    <div id="gate-20" class="gate-row hidden p-2 bg-gray-50 dark:bg-gray-700 rounded-lg shadow-sm">
                        <div class="gate-row-grid">
                            <h3 class="gate-label">Gate 20</h3>
                            <div class="relative">
                                <input type="radio" id="gate-20-clean" name="entry.1768550828" value="Clean" class="sr-only peer" checked>
                                <label for="gate-20-clean" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-blue-600 peer-checked:text-white dark:peer-checked:bg-blue-500 hover:bg-gray-300 dark:hover:bg-gray-500">Clean</label>
                            </div>
                            <div class="relative">
                                <input type="radio" id="gate-20-touch" name="entry.1768550828" value="Touch" class="sr-only peer">
                                <label for="gate-20-touch" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-yellow-500 peer-checked:text-black dark:peer-checked:bg-yellow-400 hover:bg-gray-300 dark:hover:bg-gray-500">Touch</label>
                            </div>
                            <div class="relative">
                                <input type="radio" id="gate-20-fifty" name="entry.1768550828" value="Fifty" class="sr-only peer">
                                <label for="gate-20-fifty" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-red-600 peer-checked:text-white dark:peer-checked:bg-red-500 hover:bg-gray-300 dark:hover:bg-gray-500">Fifty</label>
                            </div>
                        </div>
                    </div>

                    <!-- Gate 21 -->
                    <div id="gate-21" class="gate-row hidden p-2 bg-gray-50 dark:bg-gray-700 rounded-lg shadow-sm">
                        <div class="gate-row-grid">
                            <h3 class="gate-label">Gate 21</h3>
                            <div class="relative">
                                <input type="radio" id="gate-21-clean" name="entry.827079243" value="Clean" class="sr-only peer" checked>
                                <label for="gate-21-clean" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-blue-600 peer-checked:text-white dark:peer-checked:bg-blue-500 hover:bg-gray-300 dark:hover:bg-gray-500">Clean</label>
                            </div>
                            <div class="relative">
                                <input type="radio" id="gate-21-touch" name="entry.827079243" value="Touch" class="sr-only peer">
                                <label for="gate-21-touch" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-yellow-500 peer-checked:text-black dark:peer-checked:bg-yellow-400 hover:bg-gray-300 dark:hover:bg-gray-500">Touch</label>
                            </div>
                            <div class="relative">
                                <input type="radio" id="gate-21-fifty" name="entry.827079243" value="Fifty" class="sr-only peer">
                                <label for="gate-21-fifty" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-red-600 peer-checked:text-white dark:peer-checked:bg-red-500 hover:bg-gray-300 dark:hover:bg-gray-500">Fifty</label>
                            </div>
                        </div>
                    </div>

                    <!-- Gate 22 -->
                    <div id="gate-22" class="gate-row hidden p-2 bg-gray-50 dark:bg-gray-700 rounded-lg shadow-sm">
                        <div class="gate-row-grid">
                            <h3 class="gate-label">Gate 22</h3>
                            <div class="relative">
                                <input type="radio" id="gate-22-clean" name="entry.880248202" value="Clean" class="sr-only peer" checked>
                                <label for="gate-22-clean" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-blue-600 peer-checked:text-white dark:peer-checked:bg-blue-500 hover:bg-gray-300 dark:hover:bg-gray-500">Clean</label>
                            </div>
                            <div class="relative">
                                <input type="radio" id="gate-22-touch" name="entry.880248202" value="Touch" class="sr-only peer">
                                <label for="gate-22-touch" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-yellow-500 peer-checked:text-black dark:peer-checked:bg-yellow-400 hover:bg-gray-300 dark:hover:bg-gray-500">Touch</label>
                            </div>
                            <div class="relative">
                                <input type="radio" id="gate-22-fifty" name="entry.880248202" value="Fifty" class="sr-only peer">
                                <label for="gate-22-fifty" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-red-600 peer-checked:text-white dark:peer-checked:bg-red-500 hover:bg-gray-300 dark:hover:bg-gray-500">Fifty</label>
                            </div>
                        </div>
                    </div>

                    <!-- Gate 23 -->
                    <div id="gate-23" class="gate-row hidden p-2 bg-gray-50 dark:bg-gray-700 rounded-lg shadow-sm">
                        <div class="gate-row-grid">
                            <h3 class="gate-label">Gate 23</h3>
                            <div class="relative">
                                <input type="radio" id="gate-23-clean" name="entry.1808248764" value="Clean" class="sr-only peer" checked>
                                <label for="gate-23-clean" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-blue-600 peer-checked:text-white dark:peer-checked:bg-blue-500 hover:bg-gray-300 dark:hover:bg-gray-500">Clean</label>
                            </div>
                            <div class="relative">
                                <input type="radio" id="gate-23-touch" name="entry.1808248764" value="Touch" class="sr-only peer">
                                <label for="gate-23-touch" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-yellow-500 peer-checked:text-black dark:peer-checked:bg-yellow-400 hover:bg-gray-300 dark:hover:bg-gray-500">Touch</label>
                            </div>
                            <div class="relative">
                                <input type="radio" id="gate-23-fifty" name="entry.1808248764" value="Fifty" class="sr-only peer">
                                <label for="gate-23-fifty" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-red-600 peer-checked:text-white dark:peer-checked:bg-red-500 hover:bg-gray-300 dark:hover:bg-gray-500">Fifty</label>
                            </div>
                        </div>
                    </div>

                    <!-- Gate 24 -->
                    <div id="gate-24" class="gate-row hidden p-2 bg-gray-50 dark:bg-gray-700 rounded-lg shadow-sm">
                        <div class="gate-row-grid">
                            <h3 class="gate-label">Gate 24</h3>
                            <div class="relative">
                                <input type="radio" id="gate-24-clean" name="entry.1586717267" value="Clean" class="sr-only peer" checked>
                                <label for="gate-24-clean" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-blue-600 peer-checked:text-white dark:peer-checked:bg-blue-500 hover:bg-gray-300 dark:hover:bg-gray-500">Clean</label>
                            </div>
                            <div class="relative">
                                <input type="radio" id="gate-24-touch" name="entry.1586717267" value="Touch" class="sr-only peer">
                                <label for="gate-24-touch" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-yellow-500 peer-checked:text-black dark:peer-checked:bg-yellow-400 hover:bg-gray-300 dark:hover:bg-gray-500">Touch</label>
                            </div>
                            <div class="relative">
                                <input type="radio" id="gate-24-fifty" name="entry.1586717267" value="Fifty" class="sr-only peer">
                                <label for="gate-24-fifty" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-red-600 peer-checked:text-white dark:peer-checked:bg-red-500 hover:bg-gray-300 dark:hover:bg-gray-500">Fifty</label>
                            </div>
                        </div>
                    </div>

                    <!-- Gate 25 -->
                    <div id="gate-25" class="gate-row hidden p-2 bg-gray-50 dark:bg-gray-700 rounded-lg shadow-sm">
                        <div class="gate-row-grid">
                            <h3 class="gate-label">Gate 25</h3>
                            <div class="relative">
                                <input type="radio" id="gate-25-clean" name="entry.1989426203" value="Clean" class="sr-only peer" checked>
                                <label for="gate-25-clean" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-blue-600 peer-checked:text-white dark:peer-checked:bg-blue-500 hover:bg-gray-300 dark:hover:bg-gray-500">Clean</label>
                            </div>
                            <div class="relative">
                                <input type="radio" id="gate-25-touch" name="entry.1989426203" value="Touch" class="sr-only peer">
                                <label for="gate-25-touch" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-yellow-500 peer-checked:text-black dark:peer-checked:bg-yellow-400 hover:bg-gray-300 dark:hover:bg-gray-500">Touch</label>
                            </div>
                            <div class="relative">
                                <input type="radio" id="gate-25-fifty" name="entry.1989426203" value="Fifty" class="sr-only peer">
                                <label for="gate-25-fifty" class="radio-label bg-gray-200 dark:bg-gray-600 peer-checked:bg-red-600 peer-checked:text-white dark:peer-checked:bg-red-500 hover:bg-gray-300 dark:hover:bg-gray-500">Fifty</label>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Time Field (Hidden by default) -->
                <div id="time-section" class="mb-5 hidden">
                    <label for="time-input" class="block text-lg font-medium text-gray-700 dark:text-gray-300 mb-2">Time (MM:SS.HH)</label>
                    <input type="text" id="time-input" name="entry.873039571"
                           inputmode="numeric"
                           class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg text-lg bg-white dark:bg-gray-700 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="e.g., 01:45.23"
                           pattern="^\d{1,2}:\d{2}\.\d{2}$"
                           title="Please enter a time in MM:SS.HH format.">
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Digits will be auto-formatted.</p>
                </div>

                <!-- Status Message -->
                <div id="status-message" class="hidden mb-4 p-3 rounded-lg text-center text-sm font-medium"></div>

                <!-- Submit Button -->
                <button type="submit" id="submit-btn" class="btn w-full bg-blue-600 text-white p-4 rounded-lg text-lg font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 transition duration-150 ease-in-out">
                    Submit
                </button>

                <!-- Reset Button -->
                <button type="button" id="reset-btn" class="btn w-full bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 p-3 rounded-lg text-md font-semibold hover:bg-gray-300 dark:hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 dark:focus:ring-offset-gray-800 transition duration-150 ease-in-out mt-3">
                    Change Station
                </button>
            </form>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 max-w-lg w-full">
            <h2 class="text-2xl font-bold mb-4 text-gray-900 dark:text-gray-100">Confirm Submission</h2>
            <div id="confirmation-summary" class="mb-6 space-y-2 text-gray-700 dark:text-gray-300">
                <!-- Summary will be populated here -->
            </div>
            <div class="flex justify-end space-x-3">
                <button id="cancel-submit-btn" class="btn bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 px-5 py-2 rounded-lg font-semibold hover:bg-gray-300 dark:hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-gray-400">
                    Cancel
                </button>
                <button id="confirm-submit-btn" class="btn bg-blue-600 text-white px-5 py-2 rounded-lg font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    Confirm Submit
                </button>
            </div>
        </div>
    </div>


    <script>
        window.addEventListener('DOMContentLoaded', (event) => {
            const form = document.getElementById('gate-form');
            const stationSelector = document.getElementById('station-selector');
            const bibSection = document.getElementById('bib-section');
            const bibInput = document.getElementById('bib-number');
            const gatesContainer = document.getElementById('gates-container');
            const timeSection = document.getElementById('time-section');
            const timeInput = document.getElementById('time-input');
            const statusMessage = document.getElementById('status-message');
            const submitBtn = document.getElementById('submit-btn');
            const resetBtn = document.getElementById('reset-btn');
            const loadingState = document.getElementById('loading-state');
            const loadingError = document.getElementById('loading-error');
            const formContent = document.getElementById('form-content');
            const raceTitle = document.getElementById('race-title');

            const confirmationModal = document.getElementById('confirmation-modal');
            const confirmationSummary = document.getElementById('confirmation-summary');
            const cancelSubmitBtn = document.getElementById('cancel-submit-btn');
            const confirmSubmitBtn = document.getElementById('confirm-submit-btn');

            // This is the Google Form's actual submission URL.
            const SUBMISSION_URL = 'https://docs.google.com/forms/u/0/d/e/1FAIpQLSe8BGyWb91SaPUdOfizgt0bZvLgCLwBp2P4gPCOHiruyRaOUw/formResponse';

            // Global maps to store station->gate mapping and finish status
            let stationGateMap = {};
            let isFinishStation = {};

            /**
             * Fetches and parses the race metadata from a local JSON file.
             * Includes retry logic and a fallback for the canvas environment.
             */
            async function fetchAndParseMetadata() {
                try {
                    // Fetch the raw JSON file from the same origin
                    // The timestamp is to prevent browser caching.
                    const response = await fetch(`./current_race.json?timestamp=${new Date().getTime()}`);

                    if (!response.ok) {
                        throw new Error(`Failed to fetch current_race.json (status: ${response.status})`);
                    }

                    const metadata = await response.json();

                    // Basic validation of the fetched metadata
                    console.log("Fetched metadata:", metadata);

                    if (!metadata.race_name || !metadata.stations) {
                        throw new Error("Invalid metadata format. 'race_name' or 'stations' missing.");
                    }

                    return metadata;

                } catch (error) {
                    // Check if this is the "Failed to parse URL" error specific to the canvas
                    if (error.message.includes("Failed to parse URL")) {
                        console.warn("Canvas environment detected. Using hardcoded fallback metadata.");
                        // Return the hardcoded fallback metadata
                        return {
                            "race_name": "Test Race (Canvas)",
                            "stations": [
                                { "name": "Start", "max_gate": 3 },
                                { "name": "Station A", "max_gate": 8 },
                                { "name": "Finish", "is_finish": true }
                            ]
                        };
                    }

                    // For other errors, use the retry logic
                    console.error("Error fetching or parsing metadata:", error);
                    loadingError.textContent = `Error: ${error.message}. Retrying in 5s...`;
                    return null;
                }
            }

            /**
             * Populates the station selector and gate map from the parsed metadata.
             */
            function buildStationUI(metadata) {
                // Set the race title
                raceTitle.textContent = metadata.race_name;

                // Clear any existing options
                stationSelector.innerHTML = '<option value="" disabled selected>Select a station</option>';
                stationGateMap = {};
                isFinishStation = {};

                let lastMaxGate = 0;

                metadata.stations.forEach(station => {
                    const option = document.createElement('option');

                    // Use a unique value for the selector, e.g., "Station A"
                    let stationName = station.name;
                    if (stationName === "A" || stationName === "B" || stationName === "C" || stationName === "D") {
                        stationName = `Station ${station.name}`;
                    }
                    option.value = stationName;
                    option.textContent = stationName;
                    stationSelector.appendChild(option);

                    // Store finish status
                    isFinishStation[stationName] = !!station.is_finish;

                    // Build the gate map
                    if (station.max_gate) {
                        const startGate = lastMaxGate + 1;
                        const endGate = station.max_gate;
                        stationGateMap[stationName] = [];
                        for (let i = startGate; i <= endGate; i++) {
                            stationGateMap[stationName].push(i);
                        }
                        lastMaxGate = station.max_gate;
                    } else {
                        stationGateMap[stationName] = []; // e.g., for Finish station
                    }
                });
            }

            /**
             * Shows/hides form sections based on the selected station.
             */
            function updateFormVisibility() {
                const selectedStation = stationSelector.value;
                const gatesToShow = stationGateMap[selectedStation] || [];
                const isFinish = isFinishStation[selectedStation] || false;

                // If no station is selected, hide everything
                if (!selectedStation) {
                    bibSection.classList.add('hidden');
                    gatesContainer.classList.add('hidden');
                    timeSection.classList.add('hidden');
                    bibInput.disabled = true;
                    timeInput.disabled = true;
                    stationSelector.disabled = false;
                    return;
                }

                // A station is selected, so lock the selector
                stationSelector.disabled = true;

                // Show Bib section
                bibSection.classList.remove('hidden');
                bibInput.disabled = false;
                // Focus the bib input
                bibInput.focus();

                // Show/hide gates
                if (gatesToShow.length > 0) {
                    gatesContainer.classList.remove('hidden');
                    // Loop through all possible gates (1-25)
                    for (let i = 1; i <= 25; i++) {
                        const gateRow = document.getElementById(`gate-${i}`);
                        if (!gateRow) continue; // Skip if gate doesn't exist in HTML

                        const inputs = document.querySelectorAll(`input[name="${gateRow.querySelector('input[type=radio]').name}"]`);

                        if (gatesToShow.includes(i)) {
                            gateRow.classList.remove('hidden');
                            // Enable radio buttons for this gate
                            inputs.forEach(input => input.disabled = false);
                        } else {
                            gateRow.classList.add('hidden');
                            // Disable radio buttons for this gate
                            inputs.forEach(input => input.disabled = true);
                        }
                    }
                } else {
                    gatesContainer.classList.add('hidden');
                    // Disable all gate inputs
                    for (let i = 1; i <= 25; i++) {
                        const gateRow = document.getElementById(`gate-${i}`);
                        if (gateRow) {
                            const inputs = document.querySelectorAll(`input[name="${gateRow.querySelector('input[type=radio]').name}"]`);
                            inputs.forEach(input => input.disabled = true);
                        }
                    }
                }

                // Show/hide time field
                if (isFinish) {
                    timeSection.classList.remove('hidden');
                    timeInput.disabled = false;
                    timeInput.required = true;
                } else {
                    timeSection.classList.add('hidden');
                    timeInput.disabled = true;
                    timeInput.required = false;
                }
            }

            /**
             * Initializes the application, fetches data, and sets up listeners.
             */
            async function initializeApp() {
                loadingState.classList.remove('hidden');
                loadingError.textContent = '';
                formContent.classList.add('hidden');

                let metadata = null;
                while (!metadata) { // Loop until we get metadata (either real or fallback)
                    metadata = await fetchAndParseMetadata();
                    if (!metadata) {
                        // This means a retriable error occurred
                        // Wait 5 seconds before retrying
                        await new Promise(resolve => setTimeout(resolve, 5000));
                    }
                }

                buildStationUI(metadata);

                // Hide loading state and show form
                loadingState.classList.add('hidden');
                formContent.classList.remove('hidden');

                // Set up event listeners
                stationSelector.addEventListener('change', updateFormVisibility);
                resetBtn.addEventListener('click', () => {
                    form.reset(); // Full reset
                    stationSelector.disabled = false; // Re-enable selector
                    updateFormVisibility(); // Hide all conditional fields
                    statusMessage.classList.add('hidden');
                    // Re-initialize the app to fetch new metadata
                    initializeApp();
                });
            }

            // Auto-format the time input (Right-to-Left fill)
            timeInput.addEventListener('input', function(e) {
                // Remove non-numeric characters
                let inputDigits = e.target.value.replace(/\D/g, '');

                // Limit to 6 digits (MMSSHH)
                if (inputDigits.length > 6) {
                    inputDigits = inputDigits.substring(0, 6);
                }

                // If empty, clear field
                if (inputDigits.length === 0) {
                    e.target.value = '';
                    return;
                }

                // Pad with leading zeros to ensure we always have enough for MM:SS.HH
                // We need 6 digits to extract MM, SS, HH safely
                const paddedDigits = inputDigits.padStart(6, '0');

                // Slice parts
                const mm = paddedDigits.substring(0, 2);
                const ss = paddedDigits.substring(2, 4);
                const hh = paddedDigits.substring(4, 6);

                // Format: M:SS.HH or MM:SS.HH
                // parseInt(mm, 10) removes the leading zero from minutes if present (e.g. "02" -> "2")
                // This results in "2:30.55" instead of "02:30.55"
                e.target.value = `${parseInt(mm, 10)}:${ss}.${hh}`;
            });

            // Handle form submission
            form.addEventListener('submit', async function(event) {
                event.preventDefault();

                // --- NEW BIB NUMBER VALIDATION ---
                const bibNumberInput = document.getElementById('bib-number');
                const bibNumberValue = bibNumberInput.value.trim();

                // Check if it's a non-empty string of digits (integer)
                if (!/^\d+$/.test(bibNumberValue)) {
                    statusMessage.textContent = 'Error: Bib Number must be a whole number (e.g., 123).';
                    statusMessage.className = 'block text-center text-sm font-medium p-3 rounded-lg bg-red-600 text-white';
                    statusMessage.classList.remove('hidden');
                    bibNumberInput.focus();
                    bibNumberInput.select();
                    return; // Stop the submission
                }
                // --- END NEW VALIDATION ---

                if (!form.checkValidity()) {
                    form.reportValidity();
                    statusMessage.textContent = 'Please fill out all required fields.';
                    statusMessage.className = 'block text-center text-sm font-medium p-3 rounded-lg bg-red-600 text-white';
                    statusMessage.classList.remove('hidden');
                    return;
                }

                // --- Build Confirmation Summary ---
                confirmationSummary.innerHTML = ''; // Clear previous summary
                let summaryHtml = '';

                // Add Station
                summaryHtml += `<p><strong class="font-semibold text-gray-800 dark:text-gray-100">Station:</strong> ${stationSelector.value}</p>`;

                // Add Bib
                summaryHtml += `<p><strong class="font-semibold text-gray-800 dark:text-gray-100">Bib Number:</strong> ${bibInput.value}</p>`;

                // Add Gates (if any are visible)
                const gatesToShow = stationGateMap[stationSelector.value] || [];
                if (gatesToShow.length > 0) {
                    summaryHtml += '<h4 class="font-semibold text-gray-800 dark:text-gray-100 mt-2">Gates:</h4><ul class="list-disc list-inside pl-4">';
                    gatesToShow.forEach(gateNum => {
                        const gateRow = document.getElementById(`gate-${gateNum}`);
                        if (!gateRow) return;
                        const inputs = gateRow.querySelectorAll('input[type=radio]');
                        let selectedValue = 'Clean'; // Default
                        for (const input of inputs) {
                            if (input.checked) {
                                selectedValue = input.value;
                                break;
                            }
                        }
                        if (selectedValue !== 'Clean') {
                            summaryHtml += `<li><strong>Gate ${gateNum}:</strong> <span class="font-bold ${selectedValue === 'Touch' ? 'text-yellow-500' : 'text-red-500'}">${selectedValue}</span></li>`;
                        } else {
                            summaryHtml += `<li>Gate ${gateNum}: ${selectedValue}</li>`;
                        }
                    });
                    summaryHtml += '</ul>';
                }

                // Add Time (if visible)
                if (!timeInput.disabled) {
                    summaryHtml += `<p class="mt-2"><strong class="font-semibold text-gray-800 dark:text-gray-100">Time:</strong> ${timeInput.value}</p>`;
                }

                confirmationSummary.innerHTML = summaryHtml;
                confirmationModal.classList.remove('hidden');
            });

            // Handle Modal Cancel Button
            cancelSubmitBtn.addEventListener('click', () => {
                confirmationModal.classList.add('hidden');
            });

            // Handle Modal Confirm Button (Actual Submit)
            confirmSubmitBtn.addEventListener('click', async () => {
                confirmationModal.classList.add('hidden'); // Hide modal
                statusMessage.textContent = 'Submitting...';
                statusMessage.className = 'block text-center text-sm font-medium p-3 rounded-lg bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-100';
                statusMessage.classList.remove('hidden');
                submitBtn.disabled = true;

                const formData = new FormData(form);
                const selectedStation = stationSelector.value; // Save station

                try {
                    const response = await fetch(SUBMISSION_URL, {
                        method: 'POST',
                        mode: 'no-cors', // Google Forms requires no-cors
                        body: formData
                    });

                    // 'no-cors' mode means we can't read the response,
                    // so we just assume success if the request didn't throw.
                    statusMessage.textContent = 'Success! Entry recorded.';
                    statusMessage.className = 'block text-center text-sm font-medium p-3 rounded-lg bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-100';

                    // Reset the form, but keep the station
                    form.reset();
                    stationSelector.value = selectedStation; // Restore station
                    updateFormVisibility(); // Re-apply visibility rules

                    // Focus on Bib Number for next entry
                    bibInput.focus();

                } catch (error) {
                    console.error('Error submitting form:', error);
                    statusMessage.textContent = 'Error: Could not submit. Check connection.';
                    statusMessage.className = 'block text-center text-sm font-medium p-3 rounded-lg bg-red-600 text-white';
                } finally {
                    statusMessage.classList.remove('hidden');
                    submitBtn.disabled = false;
                    // Hide success/error message after 3 seconds
                    setTimeout(() => {
                        statusMessage.classList.add('hidden');
                    }, 3000);
                }
            });

            // Start the application
            initializeApp();
        });
    </script>
</body>
</html>
